<!DOCTYPE HTML>
<html>
<head>
<style type="text/css">
canvas {
	border: solid 1px black;
	float: left;
}

#objectList {
	border: solid 1px black;
	float: left;
}

.object {
	border: solid 1px black;
}
</style>
<script type="text/javascript" src="sylvester.src.js"></script>
<script type="text/javascript" src="repere.js"></script>
<script type="text/javascript" src="tiles.js"></script>
<script type="text/javascript" src="map.js"></script>
<script>
	const
	IMAGE_FOLDER = '../images/';
	
	const
	REPAINT_DELAI = 50;

	/*
	 * xxx_WIDTH, xxx_HEIGHT => nombre de pixels
	 */
	const
	SQUARE_WIDTH = 58;
	const
	SQUARE_HEIGHT = 30;

	/*
	 * xxx_SIZE => nombre de cases
	 */
	const
	MAP_SIZE = MAP.length;

	var canvas = undefined;
	var mousePosition = {
			x : 0,
			y : 0
		};
	var selectedTile = undefined;

	window.onload = function() {
		canvas = document.getElementById("canvas");

		/*
		 * On commence par précharger les images 
		 */
		preloadImages(IMAGE_FOLDER, main);

		canvas.addEventListener('mousemove', onmousemove, false);
	};

	function onmousemove(event) {
		mousePosition.x = event.clientX - canvas.offsetLeft + window.pageXOffset;
		mousePosition.y = event.clientY - canvas.offsetTop + window.pageYOffset;
		
		//console.log(fromRealCoord([mousePosition.x, mousePosition.y]));
	}

	function preloadImages(folder, callback) {
		var loadedImages = 0;
		var imageCount = 0;
		for ( var i in TERRAINS) {
			imageCount++;
			var image = TERRAINS[i];
			object = new Image();
			object.onload = function() {
				if (++loadedImages >= imageCount) {
					callback();
				}
			}
			object.src = folder + image.src;
			image.object = object;
		}
	}

	function main() {
		/*
		 * On rempli la liste de droite avec les images (terrains, batiments) dispos.
		 */
		fillObjectList();

		/*
		 * On dessine
		 */
		paint();
	}

	function paint() {
		var context = canvas.getContext("2d");
		clear(context, canvas);
		paintLand(context);
		paintGrid(context);
		paintMousePosition(context);
		paintSelectedTile(context);

		setTimeout(paint, REPAINT_DELAI);
	}

	function clear(context, canvas) {
		context.clearRect(0, 0, canvas.width, canvas.height);
	}

	function paintLand(context) {
		for ( var y = 0; y < MAP_SIZE; y++) {
			for ( var x = 0; x < MAP_SIZE; x++) {
				var image = MAP[y][x];
				if (!!image) {
					var coord = toRealCoord([x, y]);
					var posx = coord[0] - 29;// FIXME Il faut sortir ça dans une méthode 
					var posy = coord[1] + 15;// FIXME Il faut sortir ça dans une méthode 
					paintTileOnGrid(context, image, posx, posy);
				}
			}
		}
	}

	function paintTileOnGrid(context, image, x, y) {
		x += (SQUARE_WIDTH - image.object.width) * 0.5;
		y -= image.object.height * 0.5 + (image.object.height - SQUARE_HEIGHT)
				* 0.5;
		context.drawImage(image.object, x, y);
	}

	function paintGrid(context) {
		var c;
		context.lineWidth = 0.5;
		context.strokeStyle = "#ff0000";
		for ( var i = 0; i <= MAP_SIZE; i++) {
			context.beginPath();
			c = toRealCoord([i, 0]);
			context.moveTo(c[0], c[1]);
			c = toRealCoord([i, MAP_SIZE]);
			context.lineTo(c[0], c[1]);
			context.stroke();

			context.beginPath();
			c = toRealCoord([0, i]);
			context.moveTo(c[0], c[1]);
			c = toRealCoord([MAP_SIZE, i]);
			context.lineTo(c[0], c[1]);
			context.stroke();
		}
	}

	function paintMousePosition(context) {
		if (mousePosition.x == 0 && mousePosition.y == 0) {
			return;
		}
		
		var c = fromRealCoord([mousePosition.x, mousePosition.y]);
		var x = c[0];
		var y = c[1];
		
		if(x < 0 || x > MAP_SIZE - 1 || y < 0 || y > MAP_SIZE - 1) {
			return;
		}

		context.beginPath();
		c = toRealCoord([x, y]);
		context.moveTo(c[0], c[1]);
		c = toRealCoord([x + 1, y]);
		context.lineTo(c[0], c[1]);
		c = toRealCoord([x + 1, y + 1]); 
		context.lineTo(c[0], c[1]);
		c = toRealCoord([x, y + 1]);
		context.lineTo(c[0], c[1]);
		c = toRealCoord([x, y]);
		context.lineTo(c[0], c[1]);
		context.closePath();
		context.fillStyle = "red";
		context.globalAlpha = 0.5; // Transparence 
		context.fill(); // On remplit 
		context.globalAlpha = 1; // On la remet à sa valeur par défaut pour les copains 
	}

	function paintSelectedTile(context) {
		var c = fromRealCoord([mousePosition.x, mousePosition.y]);
		var x = c[0];
		var y = c[1];
		
		if(!selectedTile || x < 0 || x > MAP_SIZE - 1 || y < 0 || y > MAP_SIZE - 1) {
			return;
		}

		context.globalAlpha = 0.5; // Transparence
		c = toRealCoord([x, y]);
		paintTileOnGrid(context, selectedTile, c[0] - 29, c[1] + 15); // FIXME Il faut sortir ça dans une méthode 
		context.globalAlpha = 1; // On la remet à sa valeur par défaut pour les copains 
	}

	function fillObjectList() {
		var table = document.getElementById("objectList");
		for ( var i in TERRAINS) {
			var tr = document.createElement('tr');
			table.appendChild(tr);
			var td = document.createElement('td');
			td.className = 'object';
			tr.appendChild(td);
			var image = document.createElement('img');
			image.id = i;
			image.src = IMAGE_FOLDER + TERRAINS[i].src;
			image.onclick = function(e) {
				console.log(e.target.id);
				selectedTile = TERRAINS[e.target.id];
			}
			td.appendChild(image);
		}
		for ( var i in BUILDINGS) {
			var tr = document.createElement('tr');
			table.appendChild(tr);
			var td = document.createElement('td');
			td.className = 'object';
			tr.appendChild(td);
			var image = document.createElement('img');
			image.src = IMAGE_FOLDER + BUILDINGS[i].src;
			td.appendChild(image);
		}
	}
</script>
</head>
<body>
	<canvas id="canvas" width="986" height="768"></canvas>
	<table id="objectList"></table>
</body>
</html>
