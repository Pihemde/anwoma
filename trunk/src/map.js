const MAP = [
	[{ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}],
	[{ground: TERRAINS.herbe1}, undefined,                 {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}],
	[{ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}],
	[{ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}],
	[{ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}],
	[{ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}],
	[{ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}],
	[{ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}],
	[{ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}],
	[{ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe2}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}],
	[{ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}],
	[{ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}],
	[{ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}],
	[{ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}],
	[{ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}],
	[{ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}],
	[{ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1}, {ground: TERRAINS.herbe1, building: BUILDINGS.rocher1}],
];

var Map = function() {
	var Class = function(canvas, width, height, mapDescr) {
		this.canvas = canvas;
		this.context = canvas.getContext("2d");
		this.width = width;
		this.height = height;
		this.tiles = [];
		for(var y=0; y<this.height; y++) {
			this.tiles[y] = [];
			for(var x=0; x<this.width; x++) {
				var tileDescr = undefined;
				if(!!mapDescr[y] && !!mapDescr[y][x]) {
					tileDescr = mapDescr[y][x];
				}
				this.tiles[y][x] = new Tile(tileDescr);
			}
		}
	};
	Class.prototype.toRealCoord = function(coord) {
		var angle = Math.PI/4;

		var transform = Matrix.Rotation(angle);
		coord = $M([[coord[0]], [coord[1]]]);
		coord = transform.multiply(coord);
		var r = [
			Math.round(coord.elements[0][0] / Math.sqrt(2) * 58),
			Math.round(coord.elements[1][0] / Math.sqrt(2) * 30)
		];

		r = [
			r[0] + SQUARE_WIDTH*this.width/2,
			r[1]
		];
		return r;
	}

	Class.prototype.fromRealCoord = function(coord) {
		var angle = -Math.PI/4;

		coord = [
			coord[0] - SQUARE_WIDTH*this.width/2,
			coord[1]
		];
		
		coord = $M([[coord[0] / 58 * Math.sqrt(2)], [coord[1] / 30 * Math.sqrt(2)]]);
		var transform = Matrix.Rotation(angle);
		coord = transform.multiply(coord);
	
		return [
			Math.floor(coord.elements[0][0]),
			Math.floor(coord.elements[1][0])
		];
	}
	Class.prototype.paint = function() {
		paintLand(this);
		paintGrid(this);
	}
	function paintLand(map) {
		// Clear all the map
		map.context.clearRect(0, 0, map.canvas.width, map.canvas.height);
		// Now, we can draw the map
		for(var y=0; y<map.height; y++) {
			for(var x=0; x<map.width; x++) {
				map.tiles[y][x].paint(map, x, y);
			}
		}
	}

	function paintGrid(map) {
		var c;
		map.context.lineWidth = 0.5;
		map.context.strokeStyle = "#ff0000";
		for ( var i = 0; i <= map.width; i++) {
			map.context.beginPath();
			c = map.toRealCoord([i, 0]);
			map.context.moveTo(c[0], c[1]);
			c = map.toRealCoord([i, map.height]);
			map.context.lineTo(c[0], c[1]);
			map.context.stroke();
		}
		for ( var i = 0; i <= map.height; i++) {
			map.context.beginPath();
			c = map.toRealCoord([0, i]);
			map.context.moveTo(c[0], c[1]);
			c = map.toRealCoord([map.width, i]);
			map.context.lineTo(c[0], c[1]);
			map.context.stroke();
		}
	}
	return Class;
}();

