<!--
TODO TODO TODO TODO TODO TODO TODO TODO TODO TODO TODO TODO TODO TODO TODO TODO TODO TODO TODO TODO

 - Il nous faut une méthode pratique qui permette de passer de 2 entiers représentant les indexes
   des objets dans un tableau à un objet ayant 2 membres x et y representant les coordonnées
   d'affichage de l'image en pixels.
 - Il nous faut une méthode pratique inverse de la précédente qui prenne 2 entiers représentant
   des coordonnées en pixels et qui retourne un objet ayant 2 membres i et j.
 - Il faut sortir tout le code JS de la page HTML vers des fichiers xxx.js.   

TODO TODO TODO TODO TODO TODO TODO TODO TODO TODO TODO TODO TODO TODO TODO TODO TODO TODO TODO TODO
-->

<!DOCTYPE HTML>
<html>
<head>
<style type="text/css">
canvas {
	border: solid 1px black;
	float: left;
}

#objectList {
	border: solid 1px black;
	float: left;
}

.object {
	border: solid 1px black;
}
</style>
<script type="text/javascript" src="../lib/sylvester.src.js"></script>
<script type="text/javascript" src="tiles.js"></script>
<script type="text/javascript" src="map.js"></script>
<script>
	const
	IMAGE_FOLDER = '../images/';
	
	const
	REPAINT_DELAI = 50;

	/*
	 * xxx_WIDTH, xxx_HEIGHT => nombre de pixels
	 */
	const
	SQUARE_WIDTH = 58;
	const
	SQUARE_HEIGHT = 30;

	/*
	 * xxx_SIZE => nombre de cases
	 */
	const
	MAP_SIZE = MAP.length;
	 
	var MMAP = []; // Memory MAP   

	var map = undefined;
	var mousePosition = {
			x : 0,
			y : 0
		};
	var selectedTile = undefined;

	window.onload = function() {
		/*
		 * On commence par précharger les images 
		 */
		preloadImages(IMAGE_FOLDER, main);
		
		/*
		 * On instancie les objets
		 */
		//loadingMap();

		canvas.addEventListener('mousemove', onmousemove, false);
		canvas.addEventListener('click', onclick, false);
	};

	function onmousemove(event) {
		mousePosition.x = event.clientX - canvas.offsetLeft + window.pageXOffset;
		mousePosition.y = event.clientY - canvas.offsetTop + window.pageYOffset;
		//console.log(mousePosition.x, mousePosition.y);
		//console.log(fromRealCoord([mousePosition.x, mousePosition.y]));
	}

	function onclick(event) {
		mousePosition.x = event.clientX - canvas.offsetLeft + window.pageXOffset;
		mousePosition.y = event.clientY - canvas.offsetTop + window.pageYOffset;
		c = fromRealCoord([mousePosition.x, mousePosition.y]);
		
		// 1er cas, l'utilisateur a selectionné l'outil de destruction 
		
		// 2ème cas, l'utilisateur a selectionné un objet dans la liste des terrains/batiments/... 
		
	}

	function preloadImages(folder, callback) {
		var loadedImages = 0;
		var imageCount = 0;
		var toPreload = [ TERRAINS, BUILDINGS ];
		for(var p in toPreload)
		for ( var i in toPreload[p]) {
			imageCount++;
			var image = toPreload[p][i];
			var object = new Image();
			object.onload = function() {
				if (++loadedImages >= imageCount) {
					callback();
				}
			}
			object.src = folder + image.src;
			image.object = object;
		}
	}
	
	function loadingMap() {
		// Effectuer une copie de la carte dans le tableau MMAP 
		for(var i = 0 ; i < MAP_SIZE ; i++) {
			for(var j = 0 ; j < MAP_SIZE ; j++) {
				//MMAP[i][j] = 
			}
		}
	}

	function main() {
		/*
		 * On rempli la liste de droite avec les images (terrains, batiments) dispos.
		 */
		fillObjectList();

		var canvas = document.getElementById("canvas");
		map = new Map(canvas, MAP_SIZE, MAP_SIZE, MAP);
		/*
		 * On dessine
		 */
		paint();
	}

	function paint() {
		map.paint();
		paintMousePosition(map.context);
		paintSelectedTile(map.context);

		setTimeout(paint, REPAINT_DELAI);
	}

	function paintLand(context) {
		for ( var y = 0; y < MAP_SIZE; y++) {
			for ( var x = 0; x < MAP_SIZE; x++) {
				var tile = MAP[y][x];
				Tile.draw(tile, context, x, y);
			}
		}
	}

	function paintMousePosition(context) {
		if (mousePosition.x == 0 && mousePosition.y == 0) {
			return;
		}
		
		var c = map.fromRealCoord([mousePosition.x, mousePosition.y]);
		var x = c[0];
		var y = c[1];
		
		if(x < 0 || x > MAP_SIZE - 1 || y < 0 || y > MAP_SIZE - 1) {
			return;
		}

		context.beginPath();
		c = map.toRealCoord([x, y]);
		context.moveTo(c[0], c[1]);
		c = map.toRealCoord([x + 1, y]);
		context.lineTo(c[0], c[1]);
		c = map.toRealCoord([x + 1, y + 1]); 
		context.lineTo(c[0], c[1]);
		c = map.toRealCoord([x, y + 1]);
		context.lineTo(c[0], c[1]);
		c = map.toRealCoord([x, y]);
		context.lineTo(c[0], c[1]);
		context.closePath();
		context.fillStyle = "red";
		context.globalAlpha = 0.5; // Transparence 
		context.fill(); // On remplit 
		context.globalAlpha = 1; // On la remet à sa valeur par défaut pour les copains 
	}

	function paintSelectedTile(context) {
		var c = map.fromRealCoord([mousePosition.x, mousePosition.y]);
		var x = c[0];
		var y = c[1];
		
		if(!selectedTile || x < 0 || x > MAP_SIZE - 1 || y < 0 || y > MAP_SIZE - 1) {
			return;
		}

		context.globalAlpha = 0.5; // Transparence 
		c = map.toRealCoord([x, y]);
		paintTileOnGrid(context, selectedTile, c[0] - 29, c[1] + 15); // FIXME Il faut sortir ça dans une méthode 
		context.globalAlpha = 1; // On la remet à sa valeur par défaut pour les copains 
	}
	
	function get(c) {
		return MMAP[c.i][c.j];
	}
	
	function set(c, v) {
		MMAP[c.i][c.j] = v;
	}
	
	function isBuildable(c) {
		var object = get(c);
		if(!!object.buildable && false == object.buildable) {
			return false;
		}
		return true;
	}
	
	function isDestructible(c) {
		var object = MMAP[c.i][c.j];
		if(!!object.destructible && true == object.destructible) {
			return true;
		}
		return false;
	}
	
	function destroy(c) {
		if(isDestructible(c)) {
			set(c, undefined);
		}		
	}

	function fillObjectList() {
		var table = document.getElementById("objectList");
		for ( var i in TERRAINS) {
			var tr = document.createElement('tr');
			table.appendChild(tr);
			var td = document.createElement('td');
			td.className = 'object';
			tr.appendChild(td);
			var image = document.createElement('img');
			image.id = i;
			image.src = IMAGE_FOLDER + TERRAINS[i].src;
			image.onclick = function(e) {
				console.log(e.target.id);
				selectedTile = TERRAINS[e.target.id];
			}
			td.appendChild(image);
		}
		for ( var i in BUILDINGS) {
			var tr = document.createElement('tr');
			table.appendChild(tr);
			var td = document.createElement('td');
			td.className = 'object';
			tr.appendChild(td);
			var image = document.createElement('img');
			image.src = IMAGE_FOLDER + BUILDINGS[i].src;
			td.appendChild(image);
		}
	}
</script>
</head>
<body>
	<canvas id="canvas" width="986" height="768"></canvas>
	<table id="objectList"></table>
</body>
</html>
